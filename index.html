import React, { useState, useRef, useEffect } from 'react';
import { Download, User, Calendar, Hash, ShieldCheck, Image as ImageIcon, Loader2, Settings2, Stamp, FileText } from 'lucide-react';

const App = () => {
  const certificateRef = useRef(null);
  const [libsLoaded, setLibsLoaded] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  
  const [formData, setFormData] = useState({
    name: 'Rahul Sharma',
    course: 'Scaffolding Safety Training Program',
    issueDate: new Date().toLocaleDateString('en-GB'),
    certificateId: 'FISC-2024-001',
    organization: 'FIELD INCHARGE',
    registrationNo: 'REG NO: 2024/IND/00912',
    signatoryName: 'Authorized Signatory'
  });

  const [logo, setLogo] = useState(null);
  const [bgImage, setBgImage] = useState(null);
  const [bgBlur, setBgBlur] = useState(0);
  const [bgOpacity, setBgOpacity] = useState(15);
  const [stampImg, setStampImg] = useState(null);
  const [authSign, setAuthSign] = useState(null);

  useEffect(() => {
    const loadScripts = async () => {
      const scripts = [
        'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'
      ];
      const loadScript = (src) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      };
      try {
        await Promise.all(scripts.map(loadScript));
        setLibsLoaded(true);
      } catch (error) {
        console.error("Failed to load libraries", error);
      }
    };
    loadScripts();
  }, []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e, setter) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setter(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const downloadPDF = async () => {
    if (!libsLoaded) return;
    setIsGenerating(true);
    try {
      const element = certificateRef.current;
      const html2canvas = window.html2canvas;
      const { jsPDF } = window.jspdf;

      const canvas = await html2canvas(element, {
        scale: 3,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff'
      });
      
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'px',
        format: [canvas.width, canvas.height]
      });

      pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
      pdf.save(`Certificate_${formData.name.replace(/\s+/g, '_')}.pdf`);
    } catch (error) {
      console.error("PDF Generation failed", error);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-[1600px] mx-auto flex flex-col xl:flex-row gap-8">
        
        {/* Sidebar Controls */}
        <div className="w-full xl:w-[380px] space-y-6 flex-shrink-0">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h1 className="text-xl font-black mb-6 text-slate-800 flex items-center gap-2">
              <ShieldCheck className="text-blue-600 w-6 h-6" />
              Certificate Setup
            </h1>
            
            <div className="space-y-5">
              <section>
                <h2 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-[0.2em]">Recipient</h2>
                <div className="space-y-2">
                  <div className="relative">
                    <User className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                    <input name="name" value={formData.name} onChange={handleInputChange} className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Full Name" />
                  </div>
                  <div className="relative">
                    <FileText className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                    <input name="course" value={formData.course} onChange={handleInputChange} className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Program Name" />
                  </div>
                </div>
              </section>

              <section>
                <h2 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-[0.2em]">Details</h2>
                <div className="grid grid-cols-2 gap-2">
                  <div className="relative">
                    <Hash className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                    <input name="certificateId" value={formData.certificateId} onChange={handleInputChange} className="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Cert ID" />
                  </div>
                  <div className="relative">
                    <Calendar className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                    <input name="issueDate" value={formData.issueDate} onChange={handleInputChange} className="w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Date" />
                  </div>
                </div>
              </section>

              <section>
                <h2 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-[0.2em]">Company</h2>
                <div className="relative">
                  <Settings2 className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                  <input name="registrationNo" value={formData.registrationNo} onChange={handleInputChange} className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Reg No" />
                </div>
              </section>

              <section>
                <h2 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-[0.2em]">Background</h2>
                <div className="bg-slate-50 p-3 rounded-xl border border-slate-100 space-y-4">
                  <label className="flex items-center gap-3 cursor-pointer group">
                    <div className="p-2 bg-white rounded-lg border border-slate-200 group-hover:border-blue-400">
                      <ImageIcon className="w-5 h-5 text-blue-500" />
                    </div>
                    <div className="flex-1 text-left">
                      <div className="text-xs font-bold">Upload BG</div>
                      <div className="text-[10px] text-slate-400">{bgImage ? 'Image Loaded' : 'Select Image'}</div>
                    </div>
                    <input type="file" className="hidden" accept="image/*" onChange={(e) => handleFileChange(e, setBgImage)} />
                  </label>
                  {bgImage && (
                    <div className="space-y-3 px-1">
                      <div className="flex items-center gap-4">
                        <span className="text-[10px] font-bold text-slate-400 w-12">BLUR</span>
                        <input type="range" min="0" max="15" value={bgBlur} onChange={(e) => setBgBlur(e.target.value)} className="flex-1 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                      </div>
                      <div className="flex items-center gap-4">
                        <span className="text-[10px] font-bold text-slate-400 w-12">FADE</span>
                        <input type="range" min="0" max="100" value={bgOpacity} onChange={(e) => setBgOpacity(e.target.value)} className="flex-1 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                      </div>
                    </div>
                  )}
                </div>
              </section>

              <section>
                <h2 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-[0.2em]">Uploads</h2>
                <div className="grid grid-cols-2 gap-2">
                  <label className="flex flex-col items-center p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-blue-400 text-center">
                    <ImageIcon className="w-4 h-4 text-slate-400 mb-1" />
                    <span className="text-[9px] font-black uppercase">Logo</span>
                    <input type="file" className="hidden" accept="image/*" onChange={(e) => handleFileChange(e, setLogo)} />
                  </label>
                  <label className="flex flex-col items-center p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-blue-400 text-center">
                    <Stamp className="w-4 h-4 text-slate-400 mb-1" />
                    <span className="text-[9px] font-black uppercase">Stamp</span>
                    <input type="file" className="hidden" accept="image/*" onChange={(e) => handleFileChange(e, setStampImg)} />
                  </label>
                  <label className="flex flex-col items-center p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:border-blue-400 text-center col-span-2">
                    <FileText className="w-4 h-4 text-slate-400 mb-1" />
                    <span className="text-[9px] font-black uppercase">Authorized Signature</span>
                    <input type="file" className="hidden" accept="image/*" onChange={(e) => handleFileChange(e, setAuthSign)} />
                  </label>
                </div>
              </section>

              <button
                onClick={downloadPDF}
                disabled={!libsLoaded || isGenerating}
                className={`w-full py-3 px-6 rounded-xl font-black text-xs uppercase tracking-widest shadow-xl flex items-center justify-center gap-2 transition-all ${
                  !libsLoaded || isGenerating ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-900 hover:bg-blue-600 text-white'
                }`}
              >
                {isGenerating ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4" />}
                {isGenerating ? 'Exporting PDF...' : 'Download PDF'}
              </button>
            </div>
          </div>
        </div>

        {/* Certificate Display Area */}
        <div className="flex-1 overflow-x-auto pb-10">
          <div className="inline-block min-w-full">
            <div className="bg-slate-200 p-8 rounded-2xl shadow-inner border border-slate-300 flex justify-center">
              
              {/* THE CERTIFICATE CANVAS */}
              <div 
                ref={certificateRef}
                className="relative bg-white shadow-2xl overflow-hidden"
                style={{ 
                  width: '1122px', 
                  height: '793px', 
                  fontFamily: "'Segoe UI', Roboto, sans-serif" 
                }}
              >
                {/* 1. Background Image Layer */}
                {bgImage && (
                  <div className="absolute inset-0 z-0 pointer-events-none" style={{ opacity: bgOpacity / 100, filter: `blur(${bgBlur}px)` }}>
                    <img src={bgImage} className="w-full h-full object-cover" alt="Background" />
                  </div>
                )}

                {/* 2. Outer Border */}
                <div className="absolute inset-6 border border-slate-300 z-10 pointer-events-none"></div>
                
                {/* 3. Inner Double Border */}
                <div className="absolute inset-10 border-[8px] border-double border-slate-900 z-10 pointer-events-none"></div>

                {/* 4. CONTENT LAYER - Perfectly contained within the inset-10 border */}
                <div className="absolute inset-10 z-20 flex flex-col px-12 py-8">
                  
                  {/* HEADER */}
                  <div className="flex flex-col items-center">
                    {logo ? (
                      <img src={logo} alt="Logo" className="h-20 w-auto object-contain mb-2" />
                    ) : (
                      <div className="flex items-center gap-3 mb-2">
                        <div className="bg-slate-900 text-white p-3 rounded-xl">
                          <ShieldCheck className="w-10 h-10" />
                        </div>
                        <div className="text-left leading-none">
                          <div className="text-3xl font-black text-slate-900 tracking-tighter">FIELD</div>
                          <div className="text-3xl font-black text-blue-700 tracking-tighter">INCHARGE</div>
                        </div>
                      </div>
                    )}
                    <div className="text-[10px] font-black text-slate-500 tracking-widest uppercase mt-3 mb-4">
                      {formData.registrationNo}
                    </div>
                  </div>

                  {/* BODY (Expands to push footer down) */}
                  <div className="flex-1 flex flex-col items-center justify-center text-center px-10">
                    <h1 className="text-5xl font-black text-slate-900 mb-4 tracking-widest uppercase border-y-2 border-slate-900 py-4 w-full max-w-3xl">
                      Certificate of Completion
                    </h1>
                    
                    <p className="text-xl text-slate-500 italic mb-3">This is to certify that</p>
                    
                    <h2 className="text-5xl font-black text-slate-900 mb-4 uppercase tracking-tight italic border-b-[3px] border-slate-200 pb-2 w-full max-w-xl">
                      {formData.name}
                    </h2>

                    <p className="text-xl text-slate-700 leading-relaxed max-w-3xl">
                      Has successfully completed the <span className="font-bold text-blue-700">{formData.course}</span>
                      <br />
                      <span className="text-base text-slate-500 mt-2 block font-medium">
                        Including Online Training, Technical Assessment, and Online Examination, and has demonstrated 
                        required knowledge and safety competency as per industry standards.
                      </span>
                    </p>
                  </div>

                  {/* FOOTER (Grid locks items perfectly left, center, right) */}
                  <div className="grid grid-cols-3 gap-6 items-end w-full mt-auto pt-2 pb-2">
                    
                    {/* Left: Issue Date */}
                    <div className="text-left">
                      <p className="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-1">Issue Date</p>
                      <div className="text-lg font-bold text-slate-900 border-b-2 border-slate-300 pb-1 w-48">
                        {formData.issueDate}
                      </div>
                    </div>

                    {/* Center: Stamp */}
                    <div className="flex justify-center">
                      {stampImg ? (
                        <img src={stampImg} className="h-28 w-28 object-contain mix-blend-multiply opacity-95" alt="Stamp" />
                      ) : (
                        <div className="h-24 w-24 border-2 border-dashed border-slate-300 rounded-full flex flex-col items-center justify-center">
                          <Stamp className="w-8 h-8 text-slate-300 mb-1" />
                          <span className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Stamp</span>
                        </div>
                      )}
                    </div>

                    {/* Right: Signature & ID */}
                    <div className="text-right flex flex-col items-end">
                      <div className="relative w-64 h-12 mb-2">
                        {authSign ? (
                          <img src={authSign} className="absolute bottom-0 right-0 max-h-32 max-w-full object-contain" alt="Signature" />
                        ) : (
                          <div className="absolute bottom-0 w-full border-b border-dashed border-slate-300"></div>
                        )}
                      </div>
                      <div className="w-64 border-t-2 border-slate-900 pt-2">
                        <p className="font-black text-slate-900 uppercase text-sm leading-tight">
                          {formData.signatoryName}
                        </p>
                        <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">
                          Cert ID: <span className="text-slate-900">{formData.certificateId}</span>
                        </p>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
